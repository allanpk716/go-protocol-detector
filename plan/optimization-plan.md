# Go 协议检测器项目优化计划

## 项目概述
这是一个基于 Go 的网络协议检测工具，用于识别多种网络协议（RDP、SSH、FTP、SFTP、Telnet、VNC）的活跃服务。

**当前评估**: 6/10 - 功能完整但存在稳定性和代码质量问题

---

## 阶段 1: 核心稳定性修复 (高优先级) 🔴

### 1.1 修复并发安全问题
**文件**: `pkg/scan_tools.go:139-161`
**问题**: 多个 goroutine 同时写入 map 存在竞态条件
```go
// 当前代码
case revCheckResult := <-checkResultChan:
    outInfo.SuccessMap[revCheckResult.Host] = revCheckResult // 并发不安全
```
**解决方案**: 使用 `sync.Map` 或添加互斥锁
**状态**: ⏳ 待处理

### 1.2 加强输入验证
**文件**: `pkg/scan_tools.go:252-277`
**问题**: IP 范围解析缺乏充分验证，可能导致缓冲区溢出
```go
// 当前代码
ipSplit := strings.Split(inputHostString, "-")
// 缺乏对恶意输入的验证
```
**解决方案**: 添加严格的输入验证和边界检查
**状态**: ⏳ 待处理

### 1.3 优化网络读取安全
**文件**: `pkg/detector.go:96`
**问题**: 无限制读取网络数据，可能导致内存耗尽
```go
// 当前代码
_, err = conn.Read(readBuf)
```
**解决方案**: 实现读取限制和超时控制
**状态**: ⏳ 待处理

### 1.4 统一错误处理
**文件**: `pkg/scan_tools.go:183-185`
**问题**: 错误处理不一致，可能导致 goroutine 泄漏
```go
// 当前代码
if err != nil {
    wg.Done()
    return err
}
```
**解决方案**: 统一错误处理模式，确保资源正确清理
**状态**: ⏳ 待处理

---

## 阶段 2: 代码质量提升 (中优先级) 🟡

### 2.1 升级 Go 版本
**文件**: `go.mod:3`
**问题**: 使用过时的 Go 版本 1.14
```go
// 当前代码
go 1.14
```
**解决方案**: 升级到支持的 Go 版本（1.19+）
**状态**: ⏳ 待处理

### 2.2 标准化日志
**文件**: `pkg/scan_tools.go:23-26`
**问题**: 使用 println 而非标准日志库
```go
// 当前代码
println("threads is set to 1000")
```
**解决方案**: 使用标准日志库替换 println
**状态**: ⏳ 待处理

### 2.3 修复函数命名
**文件**: `pkg/scan_tools.go:407`
**问题**: 函数名拼写错误
```go
// 当前代码
func String2ProcotolType(input string) ProtocolType {
// 应该是 String2ProtocolType
```
**解决方案**: 修正函数名拼写错误
**状态**: ⏳ 待处理

### 2.4 更新依赖项
**文件**: `go.mod:10`
**问题**: 使用过时且存在安全漏洞的 crypto 版本
```go
// 当前代码
golang.org/x/crypto v0.0.0-20210317152858-513c2a44f670
```
**解决方案**: 更新到最新稳定版本
**状态**: ⏳ 待处理

---

## 阶段 3: 可维护性改进 (低优先级) 🟢

### 3.1 改进测试质量
**文件**: `pkg/detector_test.go:26-85`
**问题**: 测试中硬编码 IP 地址和凭据，缺乏可移植性
**解决方案**: 使用 mock 和测试数据，提高测试可移植性
**状态**: ⏳ 待处理

### 3.2 添加边界测试
**问题**: 缺乏对异常输入的测试用例
**解决方案**: 添加边界条件和错误场景测试
**状态**: ⏳ 待处理

### 3.3 添加配置文件支持
**文件**: 多个文件中的硬编码配置
**解决方案**: 实现配置文件支持，减少硬编码
**状态**: ⏳ 待处理

### 3.4 完善文档
**问题**: 缺乏详细的 API 文档和使用示例
**解决方案**: 添加更详细的文档和示例
**状态**: ⏳ 待处理

---

## 已排除的问题 (适用于扫描工具)

### SSH 主机密钥验证
**文件**: `internal/feature/sftp/sftp.go:64`
**说明**: `InsecureIgnoreHostKey()` 在协议检测场景下是合理的选择，因为：
- 工具目的是检测服务存在性，不是建立安全连接
- 主机密钥验证会大大增加扫描复杂度和时间
- 扫描时通常不知道目标主机密钥

**状态**: ✅ 保持现状

---

## 进度追踪

### 完成状态图例
- ✅ 已完成
- ⏳ 待处理
- 🔄 进行中
- ❌ 已跳过

### 总体进度
- 阶段 1 (高优先级): 0/4 完成
- 阶段 2 (中优先级): 0/4 完成
- 阶段 3 (低优先级): 0/4 完成
- **总进度**: 0/12 完成 (0%)

### 预估工作量
- 阶段 1: 2-3 小时
- 阶段 2: 1-2 小时
- 阶段 3: 2-3 小时
- **总计**: 5-8 小时

---

## 修改日志

| 日期 | 项目 | 状态 | 备注 |
|------|------|------|------|
| 2025-11-04 | 创建优化计划 | ✅ | 初始版本，共12项优化任务 |

---

## 注意事项

1. **向后兼容**: 确保修改不会破坏现有功能
2. **测试验证**: 每项修改后应运行测试验证
3. **渐进式改进**: 建议按阶段顺序进行修改
4. **文档更新**: 修改后及时更新相关文档